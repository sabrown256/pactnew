#
# pre-Makefile for Python wrappers
#
# Files and Directories
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

PyPACTVers = 2.numeric

lpycfg = none
lpyver = none
lpyinc = none
lpynum = -DHAVE_PY_NUMERIC

LibName=py_${PyPACTVers}
PyDir  = ${LibDir}/python${lpyver}/pact_${PyPACTVers}
TGTLib = ${LibDir}/lib${LibName}.a

OD = DefaultG

#
# Compiler/Loader Options
#
UniFlags =
CcFlags = ${ODC} ${lpynum} -I. -I../.. -I${lpyinc} -I${IncDir} ${MDInc} ${MDGInc}
LdFlags = -L${LibDir} ${LDFLAGS}

CCAnnounce = ${CCompiler} ${ODC} ${lpynum} ${Shared_CC_Flags} ${CFLAGS}

#
# Files to Save for Backup (pact save)
#
SaveFiles = *.c *.h

#
# Files to remove in directory clean (pact clean)
#
CleanFiles = ${hdrf} ${gso} *~ core

#
# Things upon which install depends (pact install)
#
InstallDep = ${TGTShPDB} ${TGTShPGS}
BinDep =
BinObj =

targets :
	@echo "Targets for PYTHON"
	@echo "   install   : install PYTHON headers and utilities in dev/arch"
	@echo "   link      : link PYTHON utilities for public use"
	@echo "   sharedlib : build and install PYTHON shared libs in dev/arch"
	@echo "   test      : run the PYTHON test suite"


PySrc = pact/pgs.py pact/pdb.py

Hdrs = pdbmodule.h  pdbrw.h  pgsmodule.h  pputil.h ppcommon.h  utilpgs.h

OPDBO = pdbmodule.o pdbPDBfile.o pdbmemdes.o \
        pdbdefstr.o pdbpdbdata.o pdbhashtab.o pdbhasharr.o \
        pdbassoc.o

OPMLO = pmlfield.o pmlset.o pmltopology.o \
        pmlmapping.o

OPPO  = pputil.o pptypes.o pparrays.o \
        ppdefstr.o pphashtab.o pphasharr.o ppassoc.o \
        pppdbr.o pypdbr.o pypdbl.o \
        pypdbd.o struct.o pppml.o

OPGSO = pgsmodule.o pgsdevice.o pgsgraph.o \
        pgsimage.o pgspalette.o utilpgs.o

OPDB = ${OPDBO} ${OPMLO} ${OPPO}
OPGS = ${OPDBO} ${OPMLO} ${OPPO} ${OPGSO}
Objs = ${OPGS}

gps = gp-score.c gp-pml.c gp-pdb.c   \
      gp-ppc.c gp-pgs.c gp-panacea.c \
      gp-scheme.c

gpo = gp-score.o gp-pml.o gp-pdb.o   \
      gp-ppc.o gp-pgs.o gp-panacea.o \
      gp-scheme.o

gpa = ${TGTLib}(gp-score.o) ${TGTLib}(gp-pml.o) ${TGTLib}(gp-pdb.o)   \
      ${TGTLib}(gp-ppc.o) ${TGTLib}(gp-pgs.o) ${TGTLib}(gp-panacea.o) \
      ${TGTLib}(gp-scheme.o)

ArPDBO = ${TGTLib}(pdbmodule.o) ${TGTLib}(pdbPDBfile.o) ${TGTLib}(pdbmemdes.o) \
         ${TGTLib}(pdbdefstr.o) ${TGTLib}(pdbpdbdata.o) \
         ${TGTLib}(pdbhashtab.o) ${TGTLib}(pdbhasharr.o) \
         ${TGTLib}(pdbassoc.o)

ArPMLO = ${TGTLib}(pmlfield.o) ${TGTLib}(pmlset.o) ${TGTLib}(pmltopology.o) \
         ${TGTLib}(pmlmapping.o)

ArPPO  = ${TGTLib}(pputil.o) ${TGTLib}(pptypes.o) ${TGTLib}(pparrays.o) \
         ${TGTLib}(ppdefstr.o) ${TGTLib}(ppassoc.o) \
         ${TGTLib}(pphashtab.o) ${TGTLib}(pphasharr.o) \
         ${TGTLib}(pppdbr.o) ${TGTLib}(pypdbr.o) ${TGTLib}(pypdbl.o) \
         ${TGTLib}(pypdbd.o) ${TGTLib}(struct.o) ${TGTLib}(pppml.o)

ArPGSO = ${TGTLib}(pgsmodule.o) ${TGTLib}(pgsdevice.o) ${TGTLib}(pgsgraph.o) \
         ${TGTLib}(pgsimage.o) ${TGTLib}(pgspalette.o) ${TGTLib}(utilpgs.o)

ArObjs = ${ArPDBO} ${ArPMLO} ${ArPPO} ${ArPGSO} ${gpa}

${Objs} : ${Hdrs}
${ArObjs} : ${Hdrs}

${LibDep} : ${Hdrs} ${hdrf}

#
# Generated code rules
#

# headers

hdrf = 

IncAction = cp ../${PACTTmpDir}/{gp-*.c,py-*.h} ${PACTTmpDir}

# language bindings

SDir = ${PACTSrcDir}

LibAction = @(mkdir -p ${PyDir} ; sync ; cd ${PACTTmpDir} ; echo "bindings" ; pact SDir=\"${SDir}\" PACTSrcDir=\".\" PACTTmpDir=\".\" LibAction=@echo Hdrs=\"${SDir}/sx.h\" lpyver=${lpyver} lpyinc=${lpyinc} -f ../../pre-Make devlib)

TGTSPDB  = ${PyDir}/libpypdb.so
TGTShPDB = ${TGTSPDB}.1

TGTSPGS  = ${PyDir}/libpypgs.so
TGTShPGS = ${TGTSPGS}.1

Libs =  ${MDGLib} -lc ${DPLib} ${MDLib}

${TGTShPDB} : ${TGTLib}
	@(cd ${PyDir} ; \
	  rm -f ${TGTSPDB} $@ _pdb.so ; \
	  ${AR} -x ${TGTLib} ; \
	  ${AR} -x ../../libscore.a ; \
	  ${AR} -x ../../libpml.a ; \
	  ${AR} -x ../../libpdb.a ; \
          rm -f ${OPGSO} ; \
	  echo "${Shared_LD_Exe} ${Shared_LD_Flags} -o $@ *.o -L${LibDir} ${Libs}" ; \
	  ${Shared_LD_Exe} ${Shared_LD_Flags} -o $@ *.o -L${LibDir} ${Libs} ; \
	  ln -s ${TGTShPDB} ${TGTSPDB} ; \
	  ln -s ${TGTShPDB} _pdb.so ; \
	  rm -f *.o _____* )

${TGTShPGS} : ${TGTLib}
	@(cd ${PyDir} ; \
	  rm -f ${TGTSPGS} $@ _pgs.so ; \
	  ${AR} -x ${TGTLib} ; \
	  ${AR} -x ../../libscore.a ; \
	  ${AR} -x ../../libpml.a ; \
	  ${AR} -x ../../libpdb.a ; \
	  ${AR} -x ../../libpgs.a ; \
	  echo "${Shared_LD_Exe} ${Shared_LD_Flags} -o $@ *.o -L${LibDir} ${Libs}" ; \
	  ${Shared_LD_Exe} ${Shared_LD_Flags} -o $@ *.o -L${LibDir} ${Libs} ; \
	  ln -s ${TGTShPGS} ${TGTSPGS} ; \
	  ln -s ${TGTShPGS} _pgs.so ; \
	  rm -f *.o _____* )


#
# link 
#
link: ${TGTLib} ${PySrc}
	./link -c ${lpycfg}

#
# install 
#
install:
	pact link

#
# sharedlib
#
sharedlib:
	pact shared
	pact incinstall

#
# inform
#
inform :
	@rm -f required.objs
	@echo ${Objs} > required.objs

#
# Run the PDB test suite
#
test :
	@./pytest -c ${lpycfg}


