#
# pre-Makefile for PFTN
#
# Files and Directories
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

LibName=fpact

TGTLib = ${LibDir}/lib${LibName}.a
TGTInc = none

OD = DefaultO

#
# Compiler/Loader Options
#
CcFlags = ${ODC} -I. -I${PACTSrcDir} -I${IncDir} ${MDInc}
FcFlags = ${ODF} -I${IncDir}
LdFlags = -L${LibDir} ${LDFLAGS}

CCAnnounce = ${CCompiler} ${ODC} ${CShared} ${CFLAGS}

#
# Files to Save for Backup (make save)
#
SaveFiles = *.f

#
# Files to remove in directory clean (pact clean)
#
CleanFiles = ${gmo} *~ core

#
# Files to remove in directory clean (pact clean)
#
RemoveFiles = ${gmo} *~ core

#
# Things upon which install depends (pact install)
#
InstallDep = ${TGTLib}
BinDep =
BinObj =

#
# Required Libraries
#

targets :
	@echo "Targets for PFTN"
	@echo "   contour      : make PGS Fortran contour test"
	@echo "   fdp          : make PDB Fortran DP IO test"
	@echo "   fha          : make Fortran API of hash test"
	@echo "   install      : install PFTN headers and utilities in dev/arch"
	@echo "   link         : link PFTN utilities for public use"
	@echo "   pdb          : make PDB Fortran API tests"
	@echo "   ppc          : make PPC Fortran tests"
	@echo "   test         : run the PFTN test suite"

#
# Headers Files
#
Hdrs = 

gfs = gf-score.c gf-pml.c gf-pdb.c   \
      gf-ppc.c gf-pgs.c gf-panacea.c \
      gf-scheme.c gf-fortran.c

gms = gm-score.f gm-pml.f gm-pdb.f   \
      gm-ppc.f gm-pgs.f gm-panacea.f \
      gm-scheme.f gm-fortran.f

#
# Object Files
#

gfo = gf-score.o gf-pml.o gf-pdb.o   \
      gf-ppc.o gf-pgs.o gf-panacea.o \
      gf-scheme.o gf-fortran.o

gmo = gm-score.o gm-pml.o gm-pdb.o   \
      gm-ppc.o gm-pgs.o gm-panacea.o \
      gm-scheme.o gm-fortran.o

Objs = ${gmo} ${gfo} flibc.o scfia.o

gfa = ${TGTLib}(gf-score.o) ${TGTLib}(gf-pml.o) ${TGTLib}(gf-pdb.o)   \
      ${TGTLib}(gf-ppc.o) ${TGTLib}(gf-pgs.o) ${TGTLib}(gf-panacea.o) \
      ${TGTLib}(gf-scheme.o) ${TGTLib}(gf-fortran.o)

gma = ${TGTLib}(gm-score.o) ${TGTLib}(gm-pml.o) ${TGTLib}(gm-pdb.o)   \
      ${TGTLib}(gm-ppc.o) ${TGTLib}(gm-pgs.o) ${TGTLib}(gm-panacea.o) \
      ${TGTLib}(gm-scheme.o) ${TGTLib}(gm-fortran.o)

ArObjs = ${gma} ${gfa} ${TGTLib}(flibc.o) ${TGTLib}(scfia.o)

${ArObjs} : ${Hdrs}
${Objs} : ${Hdrs}
${LibDep} : ${Hdrs}

modules : ${LibDep}
	@touch dummy.mod
	cp *.mod ${IncDir}
	@rm -f dummy.mod ${IncDir}/dummy.mod
	@rm -rf z-${System}

${PACTTmpDir}/gm-${LibName}.f : flibc.f
	@../scripts/bproto

genmod : ${PACTTmpDir}/gm-${LibName}.f

IncAction = @pact genmod
LibAction = @(cd ${PACTTmpDir} ; pact PACTSrcDir=\".\" PACTTmpDir=\".\" LibAction=\"\" -f ../../pre-Make modules)

Libs = -lfpact ${LPDB} ${LPML} ${LSCORE} ${MDLib}


# PDB tests

pdb : ${BinDir}/pdftst ${BinDir}/pdfwts ${BinDir}/pdfgts ${BinDir}/pdfhyts

${BinDir}/pdftst : pdftst.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdftst.f -o ${BinDir}/pdftst ${Libs} ${DPLib}

${BinDir}/pdfwts : pdfwts.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdfwts.f -o ${BinDir}/pdfwts ${Libs} ${DPLib}

${BinDir}/pdfgts : pdfgts.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdfgts.f -o ${BinDir}/pdfgts ${Libs} ${DPLib}

${BinDir}/pdfhyts : pdfhyts.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdfhyts.f -o ${BinDir}/pdfhyts ${Libs} ${DPLib}

fdp : ${BinDir}/pdfdpt

${BinDir}/pdfdpt : pdfdpt.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdfdpt.f -o ${BinDir}/pdfdpt ${Libs} ${DPLib}

# PGS tests

pgs : ${BinDir}/gsftst

${BinDir}/gsftst : gsftst.f ${TGTLib}
	${FC} ${LdFlags} gsftst.f -o ${BinDir}/gsftst ${Libs}

contour : ${BinDir}/gsfctst

${BinDir}/gsfctst : gsfctst.f ${TGTLib}
	${FC} ${LdFlags} gsfctst.f -o ${BinDir}/gsfctst ${Libs}

# PPC tests

ppc : ${BinDir}/pcftst

${BinDir}/pcftst : ${TGTLib} pcftst.f
	${FC} ${LdFlags} pcftst.f -o ${BinDir}/pcftst ${Libs}

#
# SCORE tests
#

fha : ${BinDir}/schtst

${BinDir}/schtst : schtst.f ${TGTLib} ${Hdrs}
	${FC} ${FcFlags} ${PACTTmpDic}/schtst.o -o ${BinDir}/schtst ${Libs}

omp : ${BinDir}/scompt

${BinDir}/scompt : scompt.f ${TGTLib} ${Hdrs}
	${FC} ${FcFlags} ${PACTTmpDic}/scompt.o -o ${BinDir}/scompt ${Libs}


#
# link 
#
link: ${InstallDep}

#
# install
#
install:
	pact link

#
# sharedlib
#
sharedlib:
	pact shared

#
# Run the PFTN test suite
#
test :
	@./fttest

