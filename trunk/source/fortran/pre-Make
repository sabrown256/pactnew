#
# pre-Makefile for PFTN
#
# Files and Directories
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

LibName=fpact

TGTLib = ${LibDir}/lib${LibName}.a
TGTInc = none

OD = DefaultO

#
# Compiler/Loader Options
#
CcFlags = ${ODC} -I. -I${PACTSrcDir} -I${IncDir} ${MDInc}
FcFlags = ${ODF} -I${IncDir} ${MDInc}
LdFlags = -L${LibDir} ${LDFLAGS}

CCAnnounce = ${CCompiler} ${ODC} ${CShared} ${CFLAGS}
FCAnnounce = ${FCompiler} ${ODC} ${FFLAGS}

#
# Files to Save for Backup (make save)
#
SaveFiles = *.f

#
# Files to remove in directory clean (pact clean)
#
CleanFiles = ${gmo} *~ core

#
# Files to remove in directory clean (pact clean)
#
RemoveFiles = ${gmo} *~ core

#
# Things upon which install depends (pact install)
#
InstallDep = ${TGTLib}
BinDep =
BinObj =

#
# Required Libraries
#

targets :
	@echo "Targets for PFTN"
	@echo "   contour      : make PGS Fortran contour test"
	@echo "   fdp          : make PDB Fortran DP IO test"
	@echo "   fha          : make Fortran API of hash test"
	@echo "   install      : install PFTN headers and utilities in dev/arch"
	@echo "   link         : link PFTN utilities for public use"
	@echo "   panacea      : make PANACEA Fortran API tests"
	@echo "   pdb          : make PDB Fortran API tests"
	@echo "   ppc          : make PPC Fortran tests"
	@echo "   scan         : make lexical scanner test"
	@echo "   test         : run the PFTN test suite"

#
# Headers Files
#
Hdrs = fpact.h

gfs = gf-score.c gf-pml.c gf-pdb.c   \
      gf-ppc.c gf-pgs.c gf-panacea.c \
      gf-scheme.c gf-fortran.c

gms = gm-score.f gm-pml.f gm-pdb.f   \
      gm-ppc.f gm-pgs.f gm-panacea.f \
      gm-scheme.f gm-fortran.f

#
# Object Files
#

gfo = gf-score.o gf-pml.o gf-pdb.o   \
      gf-ppc.o gf-pgs.o gf-panacea.o \
      gf-scheme.o gf-fortran.o

gmo = gm-score.o gm-pml.o gm-pdb.o   \
      gm-ppc.o gm-pgs.o gm-panacea.o \
      gm-scheme.o gm-fortran.o

Objs = ${gmo} ${gfo} flibc.o \
       fasca.o fascb.o fascs.o fascm.o \
       famla.o fapda.o fapana.o \
       fagsa.o fagsb.o fagsc.o \
       fasxa.o

gfa = ${TGTLib}(gf-score.o) ${TGTLib}(gf-pml.o) ${TGTLib}(gf-pdb.o)   \
      ${TGTLib}(gf-ppc.o) ${TGTLib}(gf-pgs.o) ${TGTLib}(gf-panacea.o) \
      ${TGTLib}(gf-scheme.o) ${TGTLib}(gf-fortran.o)

gma = ${TGTLib}(gm-score.o) ${TGTLib}(gm-pml.o) ${TGTLib}(gm-pdb.o)   \
      ${TGTLib}(gm-ppc.o) ${TGTLib}(gm-pgs.o) ${TGTLib}(gm-panacea.o) \
      ${TGTLib}(gm-scheme.o) ${TGTLib}(gm-fortran.o)

ArObjs = ${gma} ${gfa} ${TGTLib}(flibc.o) \
         ${TGTLib}(fasca.o) ${TGTLib}(fascb.o) ${TGTLib}(fascs.o) \
         ${TGTLib}(fascm.o) \
         ${TGTLib}(famla.o) ${TGTLib}(fapda.o) ${TGTLib}(fapana.o) \
         ${TGTLib}(fagsa.o) ${TGTLib}(fagsb.o) ${TGTLib}(fagsc.o) \
         ${TGTLib}(fasxa.o)

${ArObjs} : ${Hdrs}
${Objs} : ${Hdrs}
${LibDep} : ${Hdrs}

modules : ${LibDep}
	@touch dummy.mod
	cp *.mod ${IncDir}
	@rm -f dummy.mod ${IncDir}/dummy.mod
	@rm -rf z-${System}

${PACTTmpDir}/gm-${LibName}.f : flibc.f
	@../scripts/bproto

genmod : ${PACTTmpDir}/gm-${LibName}.f

IncAction = @pact genmod
LibAction = @(cd ${PACTTmpDir} ; pact PACTSrcDir=\".\" PACTTmpDir=\".\" LibAction=\"\" -f ../../pre-Make modules)

Libs = -lfpact ${LPDB} ${LPML} ${LSCORE} ${MDLib} ${DPLib}
NGLibs = -lfpact ${LPANACEA} ${LPGS} ${MDGLib} ${LPPC} ${LPDB} ${LPML} ${LSCORE} ${MDLib} ${DPLib}

#
# SCORE tests
#

fha : ${BinDir}/schtst

${BinDir}/schtst : schtst.f ${InstallDep}
	${FC} ${LdFlags} schtst.f -o ${BinDir}/schtst ${Libs}

omp : ${BinDir}/scompt

${BinDir}/scompt : scompt.f ${InstallDep}
	${FC} ${LdFlags} scompt.f -o ${BinDir}/scompt ${Libs}

scan : ${BinDir}/sclsts

${BinDir}/sclsts : sclsts.c ${InstallDep}
	${CLD} ${LdFlags} sclsts.c -o ${BinDir}/sclsts ${Libs}

# PDB tests

pdb : ${BinDir}/pdftst ${BinDir}/pdfwts ${BinDir}/pdfgts ${BinDir}/pdfhyts

${BinDir}/pdftst : pdftst.f ${InstallDep}
	${FC} ${LdFlags} pdftst.f -o ${BinDir}/pdftst ${Libs}

${BinDir}/pdfwts : pdfwts.f ${InstallDep}
	${FC} ${LdFlags} pdfwts.f -o ${BinDir}/pdfwts ${Libs}

${BinDir}/pdfgts : pdfgts.f ${InstallDep}
	${FC} ${LdFlags} pdfgts.f -o ${BinDir}/pdfgts ${Libs}

${BinDir}/pdfhyts : pdfhyts.f ${InstallDep}
	${FC} ${LdFlags} pdfhyts.f -o ${BinDir}/pdfhyts ${Libs}

fdp : ${BinDir}/pdfdpt

${BinDir}/pdfdpt : pdfdpt.f ${InstallDep}
	${FC} ${LdFlags} pdfdpt.f -o ${BinDir}/pdfdpt ${Libs}

# PPC tests

ppc : ${BinDir}/pcftst

${BinDir}/pcftst : pcftst.f ${InstallDep}
	${FC} ${LdFlags} pcftst.f -o ${BinDir}/pcftst ${Libs}

# PGS tests

pgs : ${BinDir}/gsftst ${BinDir}/gsfgts ${BinDir}/gsfcts

${BinDir}/gsftst : gsftst.f ${InstallDep}
	${FC} ${LdFlags} gsftst.f -o ${BinDir}/gsftst ${NGLibs}

${BinDir}/gsfgts : gsfgts.f ${InstallDep}
	${FC} ${LdFlags} gsfgts.f -o ${BinDir}/gsfgts ${NGLibs}

contour : ${BinDir}/gsfcts

${BinDir}/gsfcts : gsfcts.f ${InstallDep}
	${FC} ${LdFlags} gsfcts.f -o ${BinDir}/gsfcts ${NGLibs}

#
# PANACEA tests
#
panacea : ${BinDir}/pathts ${BinDir}/pathft

${BinDir}/pathts : pathts.c ${InstallDep}
	${CLD} ${LdFlags} pathts.c -o ${BinDir}/pathts ${NGLibs}

${BinDir}/pathft : pathft.f ${InstallDep}
	${FC} ${LdFlags} pathft.f -o ${BinDir}/pathft ${NGLibs}

#
# link 
#
link: ${InstallDep}

#
# install
#
install:
	pact link

#
# sharedlib
#
sharedlib:
	pact shared

#
# Run the PFTN test suite
#
test :
	@./fatest

