#
# pre-Makefile for Portable Data Base Library
#
# Files and Directories
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

LibName=pdb

TGTLib = ${LibDir}/lib${LibName}.a
TGTInc = ${Hdrs}

OD = DefaultG

#
# Compiler/Loader Options
#
UniFlags =
CcFlags  = ${ODC} -I. -I${IncDir} ${MDInc}
FcFlags  = ${ODF} -I. -I${IncDir}
LdFlags  = -L${LibDir} ${LDFLAGS}

CCAnnounce = ${CCompiler} ${ODC} ${CShared} ${CFLAGS}

#
# Files to Save for Backup (pact save)
#
SaveFiles = *.c *.h *.f

#
# Files to remove in directory clean (pact clean)
#
CleanFiles  = 
RemoveFiles = ${BinDir}/pdbtst ${BinDir}/pdatst ${BinDir}/pdasts    \
              ${BinDir}/pdopts ${BinDir}/pdapts ${BinDir}/pdgsts    \
              ${BinDir}/pdfrts ${BinDir}/pdctst \
              ${BinDir}/pdlsts ${BinDir}/pdnormtst ${BinDir}/pdcsts \
              ${BinDir}/pdftst ${BinDir}/pdfhyts ${BinDir}/pdntst   \
              ${BinDir}/pdb2hdf ${BinDir}/pdsmp ${BinDir}/pddpts    \
              ${BinDir}/pdfdpt ${BinDir}/pxrdts ${BinDir}/pxntst    \
              ${BinDir}/pdrcts ${BinDir}/pdtdeftst ${BinDir}/pdtime \
              ${BinDir}/exambin ${BinDir}/exam

#
# Things upon which install depends (pact install)
#
InstallDep = ${TGTLib}
BinDep =
BinObj =

#
# Required Libraries
#
Libs = ${LPDB} ${LPML} ${LSCORE} ${MDLib}

DepLib = ${LibDir}/libpml.a \
	 ${LibDir}/libscore.a

targets :
	@echo "Targets for PDB"
	@echo "   bindings  : make the language bindings"
	@echo "   Cstd      : make standard tests"
	@echo "   Apps      : make pdb2hdf   "
	@echo "   Gst       : make gather test"
	@echo "   Lst       : make list test"
	@echo "   Fstd      : make standard Fortran API tests"
	@echo "   net       : make net IO test"
	@echo "   pdb2hdf   : make pdb2hdf"
	@echo "   smp       : make SMP IO test"
	@echo "   dp        : make DP IO test"
	@echo "   fdp       : make Fortran DP IO test"
	@echo "   fd        : make file descriptor test"
	@echo "   attr      : make attribute tests"
	@echo "   def       : make typedef and cast tests"
	@echo "   time      : make timing test"
	@echo "   exambin   : make exambin utility"
	@echo "   exam      : make exam utility"
	@echo "   link      : link PDB utilities for public use"
	@echo "   install   : install PDB headers and utilities in dev/arch"
	@echo "   sharedlib : build and install PDB shared libs in dev/arch"
	@echo "   test      : run the PDB test suite"

#
# Headers Files
#
Hdrs = pdb.h pdb_int.h

#
# Object Files
#
Objs = pdb.o pdbaib.o pdbmp.o pdser.o pdlow.o pdblk.o \
       pdrdwr.o pdptr.o pdprnt.o pdmemb.o \
       pdbmm.o pdconv.o pdpath.o pdbfc.o pdbnet.o pdshar.o \
       pdcsum.o pdbx.o pdszof.o pdfia.o pdbdir.o pdpar.o pdcomm.o \
       pdtgt.o pdtyp.o pdtypa.o pdtypb.o pdtypc.o pdspoke.o

ArObjs = ${TGTLib}(pdb.o) ${TGTLib}(pdbaib.o)                        \
         ${TGTLib}(pdfmt.o) ${TGTLib}(pdfmta.o)                      \
         ${TGTLib}(pdfmtb.o) ${TGTLib}(pdfmtc.o)                     \
         ${TGTLib}(pdcomm.o) ${TGTLib}(pdbmp.o) ${TGTLib}(pdser.o)   \
         ${TGTLib}(pdlow.o) ${TGTLib}(pdrdwr.o) ${TGTLib}(pdptr.o)   \
         ${TGTLib}(pdmemb.o) ${TGTLib}(pdgs.o) ${TGTLib}(pdcsum.o)   \
         ${TGTLib}(pdblk.o) ${TGTLib}(pdbmm.o) ${TGTLib}(pdconv.o)   \
         ${TGTLib}(pdpath.o) ${TGTLib}(pdbfc.o) ${TGTLib}(pdbnet.o)  \
         ${TGTLib}(pdprnt.o) ${TGTLib}(pdshar.o) ${TGTLib}(pdtgt.o)  \
         ${TGTLib}(pdbx.o) ${TGTLib}(pdfia.o)  ${TGTLib}(pdbdir.o)   \
         ${TGTLib}(pdszof.o) ${TGTLib}(pdpar.o) ${TGTLib}(pdparmp.o) \
         ${TGTLib}(pdspoke.o)

${LibDep} : ${gobj} ${hdrf} ${Hdrs} pdspoke.c

#
# Generated code rules
#

# detect

${BinDir}/detect : detect.c ${Hdrs} 
	${CCCfe} ${Cfe_LD_Flags} ${Cfe_LD_RPath} -I../score detect.c -o ${BinDir}/detect ${Cfe_LD_Lib}

detect : ${BinDir}/detect

${IncDir}/pdform.h : ${BinDir}/detect
	@(echo "detect -c ${BE} -o pdform.h" ; \
	  ${CFE} ${BinDir}/detect -c ${BE} -o ${IncDir}/pdform.h)

hdrf = ${IncDir}/pdform.h

# spokes

pdspoke.c : config-spokes pdshar.c
	config-spokes

spokef = pdspoke.c

IncAction = @pact generate


#
# standard tests
#

Cstd : ${BinDir}/pdbtst ${BinDir}/pdntst ${BinDir}/pdatst ${BinDir}/pdasts \
       ${BinDir}/pdopts ${BinDir}/pdgsts ${BinDir}/pdlsts ${BinDir}/pdnormtst \
       ${BinDir}/pdrcts ${BinDir}/pdtdeftst ${BinDir}/pdcsts ${BinDir}/pdapts \
       ${BinDir}/pdfrts ${BinDir}/pdbfts ${BinDir}/pdfdts ${BinDir}/pdfcts \
       ${BinDir}/pdctst \
       ${DepLib}
Apps : ${BinDir}/pdb2hdf

Gst : ${BinDir}/pdgsts
Lst : ${BinDir}/pdlsts

${BinDir}/pdbtst : pdbtst.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdbtst.c -o ${BinDir}/pdbtst ${Libs}

${BinDir}/pdctst : pdctst.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdctst.c -o ${BinDir}/pdctst ${Libs}

${BinDir}/pdatst : pdatst.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdatst.c -o ${BinDir}/pdatst ${Libs}

${BinDir}/pdasts : pdasts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdasts.c -o ${BinDir}/pdasts ${Libs}

${BinDir}/pdopts : pdopts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdopts.c -o ${BinDir}/pdopts ${Libs}

${BinDir}/pdapts : pdapts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdapts.c -o ${BinDir}/pdapts ${Libs}

${BinDir}/pdgsts : pdgsts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdgsts.c -o ${BinDir}/pdgsts ${Libs}

${BinDir}/pdlsts : pdlsts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdlsts.c -o ${BinDir}/pdlsts ${Libs}

${BinDir}/pdnormtst : pdnormtst.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdnormtst.c -o ${BinDir}/pdnormtst ${Libs}

${BinDir}/pdcsts : pdcsts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdcsts.c -o ${BinDir}/pdcsts ${Libs}
        
${BinDir}/pdfrts : pdfrts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdfrts.c -o ${BinDir}/pdfrts ${Libs}
        
${BinDir}/pdbfts : pdbfts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdbfts.c -o ${BinDir}/pdbfts ${Libs}
        
${BinDir}/pdfcts : pdfcts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdfcts.c -o ${BinDir}/pdfcts ${Libs}
        
Fstd : ${BinDir}/pdftst ${BinDir}/pdfhyts

${BinDir}/pdftst : pdftst.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdftst.f -o ${BinDir}/pdftst ${Libs}

${BinDir}/pdfhyts : pdfhyts.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdfhyts.f -o ${BinDir}/pdfhyts ${Libs}

#
# net io test
#
net : ${BinDir}/pdntst

${BinDir}/pdntst : pdntst.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdntst.c -o ${BinDir}/pdntst ${Libs}

#
# pdb to hdf converter
#
pdb2hdf :

${BinDir}/pdb2hdf : applications/pdb2hdf.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdb2hdf.c -o ${BinDir}/pdb2hdf ${Libs}

#
# smp i/o test
#
smp : ${BinDir}/pdsmp

${BinDir}/pdsmp : pdsmp.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdsmp.c -o ${BinDir}/pdsmp ${Libs}

#
# distributed mp i/o test
#
dp : ${BinDir}/pddpts

${BinDir}/pddpts : pddpts.c ${InstallDep} ${Hdrs}
	${CC} ${LdFlags} pddpts.c -o ${BinDir}/pddpts ${Libs} ${DPLib}

fdp : ${BinDir}/pdfdpt

${BinDir}/pdfdpt : pdfdpt.f ${InstallDep} ${Hdrs}
	${FC} ${LdFlags} pdfdpt.c -o ${BinDir}/pdfdpt ${Libs} ${DPLib}

#
# test attribute handling
#
attr : ${BinDir}/pdatst ${BinDir}/pxrdts ${BinDir}/pxntst

${BinDir}/pxrdts : pxrdts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pxrdts.c -o ${BinDir}/pxrdts ${Libs}

${BinDir}/pxntst : pxntst.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pxntst.c -o ${BinDir}/pxntst ${Libs}

#
# test cast and typedef of primitives handling
#
def : ${BinDir}/pdrcts ${BinDir}/pdtdeftst

${BinDir}/pdrcts : pdrcts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdrcts.c -o ${BinDir}/pdrcts ${Libs}

${BinDir}/pdtdeftst : pdtdeftst.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdtdeftst.c -o ${BinDir}/pdtdeftst ${Libs}

#
# test file descriptor usage
#
fd : ${BinDir}/pdfdts

${BinDir}/pdfdts : pdfdts.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdfdts.c -o ${BinDir}/pdfdts ${Libs}

#
# timing test
#
time : ${BinDir}/pdtime

${BinDir}/pdtime : pdtime.c ${InstallDep} ${Hdrs}
	${CLD} ${LdFlags} pdtime.c -o ${BinDir}/pdtime ${Libs}

#
# exam
#
exambin :
	${CLD} ${LdFlags} exambin.c -o ${BinDir}/exambin

exam :
	${CLD} ${LdFlags} exam.c -o ${BinDir}/exam

# extra commands needed when building TGTLib
LibAction = build-spokes

#
# link 
#
link: ${InstallDep}

#
# install 
#
install:
	pact incinstall
	pact link

#
# sharedlib
#
sharedlib:
	pact shared
	pact incinstall

#
# inform
#
inform :
	@rm -f required.objs
	@echo ${Objs} > required.objs

#
# Run the PDB test suite
#
test :
	@./pdtest

