#
# pre-Makefile for Portable Data Base Library
#
# Files and Directories
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

LibName=pdb

TGTLib = ${LibDir}/lib${LibName}.a
TGTInc = ${Hdrs}

OD = DefaultG

#
# Compiler/Loader Options
#
UniFlags =
CcFlags  = ${ODC} -I. -I${IncDir} ${MDInc} ${MDI_Inc}
FcFlags  = ${ODF} -I. -I${IncDir}
LdFlags  = -L${LibDir} ${LDFLAGS}

CCAnnounce = ${CCompiler} ${ODC} ${Shared_CC_Flags} ${CFLAGS}

#
# Files to Save for Backup (pact save)
#
SaveFiles = *.c *.h *.f

#
# Files to remove in directory clean (pact clean)
#
CleanFiles  = 
RemoveFiles = ${BinDir}/tpdb  ${BinDir}/tpda   ${BinDir}/tpdas      \
              ${BinDir}/tpdop ${BinDir}/tpdap  ${BinDir}/tpdgs      \
              ${BinDir}/tpdfr ${BinDir}/tpdc   ${BinDir}/tpdp       \
              ${BinDir}/tpdls ${BinDir}/tpdnrm ${BinDir}/tpdcs      \
              ${BinDir}/tpdn  ${BinDir}/tpdsmp ${BinDir}/tpddp      \
              ${BinDir}/tpdrc ${BinDir}/tpdtd  ${BinDir}/tpdds      \
              ${BinDir}/tpdf  ${BinDir}/tpdxrd ${BinDir}/tpdxn      \
              ${BinDir}/pdtime ${BinDir}/pdb2hdf                    \
              ${BinDir}/exambin ${BinDir}/exam

#
# Things upon which install depends (pact install)
#
InstallDep = ${TGTLib}
BinDep =
BinObj =

#
# Required Libraries
#
Libs = ${LPDB} ${LPML} ${LSCORE} ${MDLib}

DepLib = ${LibDir}/libpml.a \
	 ${LibDir}/libscore.a

targets :
	@echo "Targets for PDB"
	@echo "   Apps      : make pdb2hdf   "
	@echo "   attr      : make attribute tests"
	@echo "   Cstd      : make standard tests"
	@echo "   def       : make typedef and cast tests"
	@echo "   dp        : make DP IO test"
	@echo "   exam      : make exam utility"
	@echo "   exambin   : make exambin utility"
	@echo "   fd        : make file descriptor test"
	@echo "   Gst       : make gather test"
	@echo "   install   : install PDB headers and utilities in dev/arch"
	@echo "   link      : link PDB utilities for public use"
	@echo "   Lst       : make list test"
	@echo "   net       : make net IO test"
	@echo "   pdb2hdf   : make pdb2hdf"
	@echo "   sharedlib : build and install PDB shared libs in dev/arch"
	@echo "   smp       : make SMP IO test"
	@echo "   test      : run the PDB test suite"
	@echo "   time      : make timing test"
	@echo "   trans     : make text translation utility"

#
# Headers Files
#
Hdrs = pdb.h pdb_int.h pdb_old.h

#
# Object Files
#
Objs = pdb.o pdbaib.o pdbmp.o pdser.o pdlow.o pdsymt.o pdblk.o \
       pdrdwr.o pdptr.o pdprnt.o pdmemb.o pdflt.o \
       pdbmm.o pdconv.o pdpath.o pdbfc.o pdbnet.o pdshar.o \
       pdcsum.o pdbx.o pdmap.o pdszof.o pdbdir.o pdpar.o pdcomm.o \
       pdtgt.o pdtyp.o pdtypa.o pdtypb.o pdtypc.o pdspoke.o pdold.o

ArObjs = ${TGTLib}(pdb.o) ${TGTLib}(pdbaib.o)                        \
         ${TGTLib}(pdfmt.o) ${TGTLib}(pdfmta.o)                      \
         ${TGTLib}(pdfmtb.o) ${TGTLib}(pdfmtc.o) ${TGTLib}(pdsymt.o) \
         ${TGTLib}(pdcomm.o) ${TGTLib}(pdbmp.o) ${TGTLib}(pdser.o)   \
         ${TGTLib}(pdlow.o) ${TGTLib}(pdrdwr.o) ${TGTLib}(pdptr.o)   \
         ${TGTLib}(pdmemb.o) ${TGTLib}(pdgs.o)                       \
         ${TGTLib}(pdcsum.o) ${TGTLib}(pdflt.o)                      \
         ${TGTLib}(pdblk.o) ${TGTLib}(pdbmm.o) ${TGTLib}(pdconv.o)   \
         ${TGTLib}(pdpath.o) ${TGTLib}(pdbfc.o) ${TGTLib}(pdbnet.o)  \
         ${TGTLib}(pdprnt.o) ${TGTLib}(pdshar.o) ${TGTLib}(pdtgt.o)  \
         ${TGTLib}(pdbx.o) ${TGTLib}(pdmap.o) ${TGTLib}(pdbdir.o)    \
         ${TGTLib}(pdszof.o) ${TGTLib}(pdpar.o) ${TGTLib}(pdparmp.o) \
         ${TGTLib}(pdspoke.o) ${TGTLib}(pdold.o)

${LibDep} : ${hdrf} ${Hdrs} pdspoke.c scope_formats.h

#
# Generated code rules
#

# detect

${BinDir}/detect : detect.c ${Hdrs} 
	${CCCfe} ${Cfe_LD_Flags} ${Cfe_LD_RPath} -I../score detect.c -o ${BinDir}/detect ${Cfe_LD_Lib}

detect : ${BinDir}/detect

${IncDir}/pdform.h : ${BinDir}/detect
	@(echo "detect -c ${BE} -o pdform.h" ; \
	  ${CFE} ${BinDir}/detect -c ${BE} -o ${IncDir}/pdform.h)

hdrf = ${IncDir}/pdform.h

# spokes

pdspoke.c : config-spokes pdshar.c
	config-spokes

spokef = pdspoke.c

IncAction = @pact generate


#
# standard tests
#

Cstd : ${BinDir}/tpdb  ${BinDir}/tpdn  ${BinDir}/tpda  ${BinDir}/tpdas  \
       ${BinDir}/tpdop ${BinDir}/tpdgs ${BinDir}/tpdls ${BinDir}/tpdnrm \
       ${BinDir}/tpdrc ${BinDir}/tpdtd ${BinDir}/tpdcs ${BinDir}/tpdap  \
       ${BinDir}/tpdfr ${BinDir}/tpdbf ${BinDir}/tpdfd ${BinDir}/tpdfc  \
       ${BinDir}/tpdc  ${BinDir}/tpdf  ${BinDir}/tpdp  ${BinDir}/tpdds  \
       ${DepLib}
Apps : ${BinDir}/pdb2hdf

Gst : ${BinDir}/tpdgs
Lst : ${BinDir}/tpdls

${BinDir}/tpdb : tpdb.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdb.c -o ${BinDir}/tpdb ${Libs}

${BinDir}/tpdc : tpdc.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdc.c -o ${BinDir}/tpdc ${Libs}

${BinDir}/tpdf : tpdf.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdf.c -o ${BinDir}/tpdf ${Libs}

${BinDir}/tpdp : tpdp.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdp.c -o ${BinDir}/tpdp ${Libs}

${BinDir}/tpda : tpda.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpda.c -o ${BinDir}/tpda ${Libs}

${BinDir}/tpdas : tpdas.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdas.c -o ${BinDir}/tpdas ${Libs}

${BinDir}/tpdop : tpdop.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdop.c -o ${BinDir}/tpdop ${Libs}

${BinDir}/tpdap : tpdap.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdap.c -o ${BinDir}/tpdap ${Libs}

${BinDir}/tpdgs : tpdgs.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdgs.c -o ${BinDir}/tpdgs ${Libs}

${BinDir}/tpdls : tpdls.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdls.c -o ${BinDir}/tpdls ${Libs}

${BinDir}/tpdnrm : tpdnrm.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdnrm.c -o ${BinDir}/tpdnrm ${Libs}

${BinDir}/tpdcs : tpdcs.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdcs.c -o ${BinDir}/tpdcs ${Libs}
        
${BinDir}/tpdfr : tpdfr.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdfr.c -o ${BinDir}/tpdfr ${Libs}
        
${BinDir}/tpdbf : tpdbf.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdbf.c -o ${BinDir}/tpdbf ${Libs}
        
${BinDir}/tpdfc : tpdfc.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdfc.c -o ${BinDir}/tpdfc ${Libs}
        
${BinDir}/tpdds : tpdds.c ${InstallDep} ${Hdrs} ${DepLib} pdbtfr.h
	${CLD} ${LdFlags} tpdds.c -o ${BinDir}/tpdds ${Libs}
        
#
# ascii vs binary performance
#
ascii : ${BinDir}/tpdd

${BinDir}/tpdd : tpdd.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdd.c -o ${BinDir}/tpdd ${Libs} ${MDI_Lib}

#
# large file test
#
lf : ${BinDir}/tpdlf

${BinDir}/tpdlf : tpdlf.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdlf.c -o ${BinDir}/tpdlf ${Libs} ${MDI_Lib}

#
# net io test
#
net : ${BinDir}/tpdn

${BinDir}/tpdn : tpdn.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdn.c -o ${BinDir}/tpdn ${Libs}

#
# pdb to hdf converter
#
pdb2hdf :

${BinDir}/pdb2hdf : applications/pdb2hdf.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} pdb2hdf.c -o ${BinDir}/pdb2hdf ${Libs}

#
# smp i/o test
#
smp : ${BinDir}/tpdsmp

${BinDir}/tpdsmp : tpdsmp.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdsmp.c -o ${BinDir}/tpdsmp ${Libs}

#
# distributed mp i/o test
#
dp : ${BinDir}/tpddp

${BinDir}/tpddp : tpddp.c ${InstallDep} ${Hdrs} ${DepLib}
	${CC} ${LdFlags} tpddp.c -o ${BinDir}/tpddp ${Libs} ${DPLib}

#
# test attribute handling
#
attr : ${BinDir}/tpda ${BinDir}/tpdxrd ${BinDir}/tpdxn

${BinDir}/tpdxrd : tpdxrd.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdxrd.c -o ${BinDir}/tpdxrd ${Libs}

${BinDir}/tpdxn : tpdxn.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdxn.c -o ${BinDir}/tpdxn ${Libs}

#
# test cast and typedef of primitives handling
#
def : ${BinDir}/tpdrc ${BinDir}/tpdtd

${BinDir}/tpdrc : tpdrc.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdrc.c -o ${BinDir}/tpdrc ${Libs}

${BinDir}/tpdtd : tpdtd.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdtd.c -o ${BinDir}/tpdtd ${Libs}

#
# test file descriptor usage
#
fd : ${BinDir}/tpdfd

${BinDir}/tpdfd : tpdfd.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} tpdfd.c -o ${BinDir}/tpdfd ${Libs}

#
# timing test
#
time : ${BinDir}/pdtime

${BinDir}/pdtime : pdtime.c ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} pdtime.c -o ${BinDir}/pdtime ${Libs}

#
# exam
#
exambin :
	${CLD} ${LdFlags} exambin.c -o ${BinDir}/exambin

exam :
	${CLD} ${LdFlags} exam.c -o ${BinDir}/exam

trans : ${InstallDep} ${Hdrs} ${DepLib}
	${CLD} ${LdFlags} pdctrns.c -o ${BinDir}/pdctrns ${Libs}

# extra commands needed when building TGTLib
LibAction = build-spokes

#
# link 
#
link: ${InstallDep}
	pact man3install

#
# install 
#
install:
	pact link
	pact incinstall

#
# sharedlib
#
sharedlib:
	pact shared
	pact incinstall

#
# inform
#
inform :
	@rm -f required.objs
	@echo ${Objs} > required.objs

#
# Run the PDB test suite
#
test :
	@./pdtest

