#
# pre-Make for PANACEA
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

LibName=panacea

TGTLib = ${LibDir}/lib${LibName}.a
TGTExe = ${BinDir}/toul
TGTInc = panace.h panacea_int.h f77std.h

TGTScm = applications/panache.scm applications/panabgc.scm applications/panagc.scm \
         applications/panbgc.scm applications/panpgc.scm applications/panint.scm

TGTScr = applications/panache

#
# Compiler/Loader Options
#
UniFlags =
CcFlags  = ${CDebug} -I${IncDir} ${MDInc} ${MDGInc}
FcFlags  =
LdFlags  = -L${LibDir} ${LDFLAGS}

CCAnnounce = ${CCompiler} ${CDebug} ${CShared} ${CFLAGS}

#
# Files to Save for Backup (pact save)
#
SaveFiles = *.c *.h

#
# Files to remove in directory clean (pact clean)
#
CleanFiles = *~ core

#
# Things upon which install depends (pact install)
#
DepLib = ${LibDir}/libppc.a \
         ${LibDir}/libpdb.a \
         ${LibDir}/libpml.a \
	 ${LibDir}/libscore.a

InstallDep = ${TGTLib} ${TGTExe} ${TGTScr}
BinDep = ${Hdrs} ${TGTLib} toul.c ${DepLib}
BinObj = ${LdFlags} toul.c

#
# Required Libraries
#
# NOTE: building shared seems to require these:
Libs   = ${LPANACEA} ${LPGS} ${MDGLib} ${LPPC} ${LPDB} ${LPML} ${LSCORE} ${MDLib}
NGLibs = ${LPANACEA} ${LPGS} ${MDGLib} ${LPPC} ${LPDB} ${LPML} ${LSCORE} ${MDLib}
# NOTE: building static seems to require only these:
#Libs   = ${LPANACEA} ${LPDB} ${LPML} ${LSCORE} ${MDLib}
#NGLibs = ${LPANACEA} ${LPDB} ${LPML} ${LSCORE} ${MDLib}

targets :
	@echo "Targets for PANACEA"
	@echo "   bindings  : make the language bindings"
	@echo "   Cth       : make C time history tests"
	@echo "   defvar    : make variable definition test"
	@echo "   Fth       : make Fortran time history tests"
	@echo "   install   : install PANACEA headers and utilities in dev/arch"
	@echo "   link      : link PANACEA utilities for public use"
	@echo "   prep      : make preprocessing test"
	@echo "   sharedlib : build and install PANACEA shared libs in dev/arch"
	@echo "   test      : run the PANACEA test suite"

#
# Headers Files
#
Hdrs = ${TGTInc}

#
# Object Files
#
GenObjs = pagnrd.o pahand.o pafi.o pafia.o
PanObjs = padsys.o pamm.o panacea.o paccess.o pashar.o pashas.o pastr.o pavars.o \
 	  padef.o pacpp.o papkg.o pasmp.o
PPObjs  = papp.o padump.o panth.o
SorObjs = pasrc.o
Objs    = ${GenObjs} ${SorObjs} ${PanObjs} ${PPObjs}

ArBind = ${TGTLib}(gf-${LibName}.o)

ArObjs = ${TGTLib}(padef.o) ${TGTLib}(pacpp.o) ${TGTLib}(papkg.o)      \
	 ${TGTLib}(pagnrd.o) ${TGTLib}(pahand.o) ${TGTLib}(pafi.o)     \
         ${TGTLib}(panacea.o) ${TGTLib}(pashar.o) ${TGTLib}(pashas.o)  \
         ${TGTLib}(paccess.o) ${TGTLib}(padsys.o) ${TGTLib}(pamm.o)    \
         ${TGTLib}(pavars.o) ${TGTLib}(papp.o) ${TGTLib}(padump.o)     \
         ${TGTLib}(pasrc.o) ${TGTLib}(pastr.o) ${TGTLib}(pafia.o)      \
         ${TGTLib}(pasmp.o)                                            \
         ${TGTLib}(panth.o)                                            \
         ${ArBind}

${Objs} : ${Hdrs}
${LibDep} : ${Hdrs}

#
# time history tests
#
Cth : ${BinDir}/pathts

${BinDir}/pathts : pathts.c ${TGTLib}
	${CC} -c pathts.c -o ${PACTTmpDir}/pathts.o
	${CLD} ${LdFlags} ${PACTTmpDir}/pathts.o -o ${BinDir}/pathts ${NGLibs}

Fth : ${BinDir}/pathft

${BinDir}/pathft : pathft.f ${TGTLib}
	${FC} -c pathft.f -o ${PACTTmpDir}/pathft.o
	${FC} ${LdFlags} ${PACTTmpDir}/pathft.o -o ${BinDir}/pathft ${NGLibs}

#
# pata
#
${BinDir}/pata : pata.c ${TGTLib}
	${CC} -c pata.c -o ${PACTTmpDir}/pata.o
	${CLD} ${LdFlags} ${PACTTmpDir}/pata.o -o ${BinDir}/pata ${NGLibs}

#
# preprocessing test
#
prep : ${BinDir}/pacppt

${BinDir}/pacppt : pacppt.c ${TGTLib}
	${CC} -c pacppt.c -o ${PACTTmpDir}/pacppt.o
	${CLD} ${LdFlags} ${PACTTmpDir}/pacppt.o -o ${BinDir}/pacppt ${NGLibs}
#
# test new variable definition
#
defvar : ${BinDir}/padeft

${BinDir}/padeft : padeft.c ${TGTLib}
	${CC} -c padeft.c -o ${PACTTmpDir}/padeft.o
	${CLD} ${LdFlags} ${PACTTmpDir}/padeft.o -o ${BinDir}/padeft ${NGLibs}

#
# make the executable
#
${TGTExe} : ${BinDep}
	${CC} -c toul.c -o ${PACTTmpDir}/toul.o
	${CLD} ${LdFlags} ${PACTTmpDir}/toul.o -o ${TGTExe} ${Libs}

#
# link 
#
link: ${InstallDep}
	pact scminstall
	pact scrinstall

#
# install 
#
install:
	pact link
	pact incinstall
	pact scminstall
	pact scrinstall

#
# sharedlib
#
sharedlib:
	pact shared
	pact incinstall

#
# inform
#
inform :
	@rm -f required.objs
	@echo ${Objs} > required.objs

#
# Run the PANACEA test suite
#
test :
	@./patest

#
# Make C prototypes file
#
genf  = gf-${LibName}.c
bindf = ${LibName}.bind

${genf} : ${bindf}
	../scripts/bproto

bindings : ${genf}

