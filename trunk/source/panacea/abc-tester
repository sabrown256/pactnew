#!/bin/csh -f
#
# DO-TEST - full PANACEA test
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

# Setup the environment to work within
set TestDir = `pwd`
set BinDir = $top_builddir/panacea/abc/
set path = ( . $BinDir $path )
setenv ULTRA  $top_srcdir/ultra
setenv SCHEME $top_srcdir/ultra:$top_srcdir/ultra/applications:$top_srcdir/scheme/applications:$top_srcdir/scheme/syntax/c:$top_srcdir/scheme/syntax/f:$top_srcdir/scheme/syntax/m:$top_srcdir/panacea/applications:$top_srcdir/score:$top_srcdir/sx/applications:$top_srcdir/config
setenv SCHEME ${SCHEME}:$SCHEME/extensions

set LogFile  = $TestDir/abc-tester.log
set ERROR    = 0
set ABCError = FALSE
set FAIL     = "NO"
set status   = 0

rm -f $LogFile
touch $LogFile

rm -f $LogFile
echo "ENTER abc-tester" >>& $LogFile
echo "BinDir = $BinDir" >>& $LogFile
echo "TestDir = $TestDir" >>& $LogFile
echo "top_srcdir = $top_srcdir" >>& $LogFile

#--------------------------------------------------------------------------
#--------------------------------------------------------------------------

   cp $top_srcdir/panacea/abc/test/tsrc1 .
   echo -n "Running source preprocessor S ... " >>& $LogFile
   echo "$BinDir/source/s tsrc1" >>& $LogFile
   $BinDir/source/s tsrc1 >>& $LogFile
   echo "done" >>& $LogFile
   rm tsrc1

   if ($status != 0) then
      echo "                       S ..... FAILED"
      set ERROR    = 2
      set ABCError = "TRUE"
   else
      echo "                       S ..... PASSED"
   endif

#--------------------------------------------------------------------------
#--------------------------------------------------------------------------

   if ($ABCError == "FALSE") then
      cp $top_srcdir/panacea/abc/test/st.g . 
      echo -n "Running generator code A ... " >>& $LogFile
      echo "$BinDir/main/a $top_srcdir/panacea/abc/test/st.g" >>& $LogFile
      $BinDir/main/a $top_srcdir/panacea/abc/test/st.g >>& $LogFile
      echo "done" >>& $LogFile
      rm st.g

      if ($status != 0) then
         echo "                       A ..... FAILED"
         set ERROR    = 3
         set ABCError = "TRUE"
      else
         echo "                       A ..... PASSED"
      endif
   endif

#--------------------------------------------------------------------------
#--------------------------------------------------------------------------

   if ($ABCError == "FALSE") then
      echo -n "Running simulation code B ... " >>& $LogFile
      echo "$BinDir/main/b st.r00" >>& $LogFile
      $BinDir/main/b st.r00 >>& $LogFile
      echo "done" >>& $LogFile

      if ($status != 0) then
         echo "                       B ..... FAILED"
         set ERROR    = 4
         set ABCError = "TRUE"
      else
         echo "                       B ..... PASSED"
      endif
   endif

endif

#--------------------------------------------------------------------------
#--------------------------------------------------------------------------

if ($ERROR == 0) then
   rm st.* tsrc1.*
endif

echo "EXIT abc-tester" >>& $LogFile

exit($ERROR)

