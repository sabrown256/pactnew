#!/bin/csh -f
#
# CCOMP - compiler version wrapper
#
# Source Version: 3.0
# Software Release #: LLNL-CODE-422942
#
# include "cpyright.h"
#

@ err = 0

set sys = `system-id`

set comp = $0
set base = $comp:h
set comp = $comp:t
if ($comp == ccomp) then
   set comp = gcc
endif
if ($base == $comp) then
   set base = $cwd
endif
#echo "cmd  = $0"
#echo "base = $base"
#echo "comp = $comp"

# do not save us from from IBM
unsetenv OBJECT_MODE

set vers = "any"

if ($?COMPILER_VERSION == 1) then
   set vers = $COMPILER_VERSION
endif

set compilers = $base/compilers

set prenv = FALSE
set vrb   = FALSE
set args  = ""
while ($#argv > 0)
   switch ($1)
      case -cwexe:
           shift
           set comp = $1
           breaksw
      case -cwenv:
           set prenv = TRUE
           breaksw
      case -cwhelp:
           echo ""
           echo "Usage: <compiler> [-cwexe <exe>] [-cwenv] [-cwhelp] [-cwlist <opt>] [-cwvers] [-cwvrb] <args>*"
           echo "   cwexe   specify the compiler (for testing)"
           echo "   cwenv   show any environment variable settings made"
           echo "   cwhelp  this help message"
           echo "   cwlist  show compiler info"
           echo "           all    show all compilers names, versions, and paths"
           echo "                  for current platform"
           echo "           name   show all compilers names only"
           echo "                  for all platforms"
           echo "   cwvrb   show ultimate command line"
           echo ""
           exit(1)
           breaksw
      case -cwlist:
           shift
           switch ($1)
              case all:
                   grep -w $sys $compilers | sed 's/^[a-z0-9\.\-]*//'
                   breaksw
              case name:
                   grep -v '#' $compilers | awk '{print $2}' | sort | uniq
                   breaksw
           endsw
           exit(1)
           breaksw
      case -cwvers:
           shift
           set vers = $1
           breaksw
      case -cwvrb:
           set vrb = TRUE
           breaksw
      default:
           set args = ( $args $1 )
           breaksw
   endsw
   shift
end

if ($vers == any) then
   set inf = ( `grep -w $comp $compilers | grep $sys | tail -n 1` )
else
   set inf = ( `grep -w $comp $compilers | grep $sys | grep $vers` )
endif

if ($#inf > 3) then
   set exe = $inf[4]
else
   echo "No compiler found matching '$comp $vers' - exiting"
   exit(1)
endif

#--------------------------------------------------------------------------
#--------------------------------------------------------------------------

set root   = $exe:h
set BinDir = $root

#--------------------------------------------------------------------------
#--------------------------------------------------------------------------

if ($?LD_LIBRARY_PATH == 0) then
   setenv LD_LIBRARY_PATH  /usr/lib
endif

# NOTE: newest GNU compilers require this because to run
# for some reason they were not built with -rpath
# this is not for the compiled executables
if (($comp == gcc) || ($comp == g++) || ($comp == gfortran)) then
   set GNU = $exe:h
   set GNU = $GNU:h
   setenv LD_LIBRARY_PATH  $GNU/lib64:$GNU/lib:${LD_LIBRARY_PATH}

   if (-d $GNU/share/man) then
      setenv MANPATH   ${MANPATH}:$GNU/share/man
   endif
endif

#--------------------------------------------------------------------------
#--------------------------------------------------------------------------

if ($prenv == TRUE) then

   echo "LD_LIBRARY_PATH       $LD_LIBRARY_PATH"
   echo "MANPATH               $MANPATH"

else

# these are common variable which may be used by the compiler drivers
# for example the Intel compiler drivers use some of these
# we are done with them - so unset them
   unsetenv COMPILER_FAMILY
   unsetenv COMPILER_VERSION
   unsetenv COMPILER_PATH

# verbose mode diagnostic for debugging
   if ($vrb == TRUE) then
      echo "   Root: $root"
      echo "   LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
      echo "   Compile line: $exe $args"
   endif

   if (-x $exe) then
      exec $exe $args
   else
      @ err = 1
      set comp = $0
      set comp = $comp:t
      echo "${comp}: Command not found."
   endif
endif

exit($err)

